<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DISC Paradigmâ„¢ Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600;700;800;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--navy:#0D2340;--blue:#1A5A8A;--gold:#F5A623;--orange:#E85D1A;--dark:#080E18;--mid:#0F1C2E;--white:#F4F1EC;--off:#C8C4BB;--border:rgba(255,255,255,.09);--D:#1A5A8A;--I:#F5A623;--S:#2E8B57;--C:#E85D1A;}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Barlow',sans-serif;background:var(--dark);color:var(--white);min-height:100vh;}

    /* LOGIN */
    #login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem;}
    .login-card{background:rgba(15,28,46,.9);border:1px solid var(--border);border-radius:8px;padding:2.5rem;width:100%;max-width:400px;text-align:center;}
    .login-card h1{font-family:'Barlow Condensed',sans-serif;font-size:1.8rem;font-weight:900;text-transform:uppercase;margin-bottom:.5rem;}
    .login-card h1 em{font-style:normal;color:var(--gold);}
    .login-card p{font-size:.88rem;color:var(--off);margin-bottom:1.5rem;}
    .login-field{text-align:left;margin-bottom:1rem;}
    .login-field label{display:block;font-family:'Barlow Condensed',sans-serif;font-size:.75rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--gold);margin-bottom:.4rem;}
    .login-field input{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:4px;padding:.75rem 1rem;font-family:'Barlow',sans-serif;font-size:.95rem;color:var(--white);outline:none;transition:border-color .2s;}
    .login-field input:focus{border-color:rgba(245,166,35,.5);}
    .login-field input[type=password]{letter-spacing:.2em;font-size:1.1rem;}
    .btn{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:.95rem;letter-spacing:.1em;text-transform:uppercase;padding:.8rem 1.75rem;border-radius:4px;border:none;cursor:pointer;transition:all .2s;}
    .btn-primary{background:var(--orange);color:#fff;width:100%;box-shadow:0 4px 20px rgba(232,93,26,.3);}
    .btn-primary:hover{box-shadow:0 6px 28px rgba(232,93,26,.5);}
    .btn-gold{background:var(--gold);color:var(--dark);}
    .btn-gold:hover{opacity:.9;}
    .btn-ghost{background:transparent;color:rgba(244,241,236,.6);border:1px solid var(--border);}
    .btn-ghost:hover{color:var(--white);border-color:rgba(255,255,255,.2);}
    .btn-sm{padding:.45rem 1rem;font-size:.78rem;}
    .btn-danger{background:rgba(232,93,26,.15);color:var(--orange);border:1px solid rgba(232,93,26,.3);}
    .login-error{color:var(--orange);font-size:.82rem;margin-top:.5rem;display:none;}

    /* DASHBOARD LAYOUT */
    #dashboard{display:none;}
    .topbar{background:rgba(15,28,46,.95);border-bottom:1px solid var(--border);padding:.9rem 2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);}
    .topbar-brand{font-family:'Barlow Condensed',sans-serif;font-size:1.2rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:var(--gold);}
    .topbar-brand span{color:var(--white);}
    .topbar-right{display:flex;align-items:center;gap:1rem;}
    .topbar-user{font-size:.8rem;color:rgba(244,241,236,.4);}
    .main{padding:2rem;max-width:1400px;margin:0 auto;}

    /* STATS ROW */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2rem;}
    .stat-card{background:rgba(15,28,46,.7);border:1px solid var(--border);border-radius:6px;padding:1.25rem 1.5rem;}
    .stat-card .stat-n{font-family:'Barlow Condensed',sans-serif;font-size:2.2rem;font-weight:900;line-height:1;color:var(--gold);}
    .stat-card .stat-l{font-size:.75rem;letter-spacing:.12em;text-transform:uppercase;color:rgba(244,241,236,.4);margin-top:.3rem;}

    /* TABS */
    .tabs{display:flex;gap:0;margin-bottom:2rem;border-bottom:1px solid var(--border);}
    .tab{font-family:'Barlow Condensed',sans-serif;font-size:.85rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:.75rem 1.5rem;cursor:pointer;color:rgba(244,241,236,.45);border-bottom:2px solid transparent;transition:all .2s;background:none;border-top:none;border-left:none;border-right:none;}
    .tab:hover{color:var(--white);}
    .tab.active{color:var(--gold);border-bottom-color:var(--gold);}

    /* TAB PANELS */
    .tab-panel{display:none;} .tab-panel.active{display:block;}

    /* SECTION HEADER */
    .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;flex-wrap:wrap;gap:.75rem;}
    .section-title{font-family:'Barlow Condensed',sans-serif;font-size:1.2rem;font-weight:800;text-transform:uppercase;letter-spacing:.04em;}
    .section-actions{display:flex;gap:.5rem;}

    /* ORG GRID */
    .org-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-bottom:2rem;}
    .org-card{background:rgba(15,28,46,.7);border:1px solid var(--border);border-radius:6px;padding:1.25rem;transition:border-color .2s;}
    .org-card:hover{border-color:rgba(245,166,35,.25);}
    .org-name{font-family:'Barlow Condensed',sans-serif;font-size:1.1rem;font-weight:800;text-transform:uppercase;margin-bottom:.3rem;}
    .org-code{font-family:'Barlow Condensed',sans-serif;font-size:1.4rem;font-weight:900;letter-spacing:.2em;color:var(--gold);margin:.5rem 0;}
    .org-meta{font-size:.78rem;color:rgba(244,241,236,.4);margin-bottom:.75rem;}
    .org-stats{display:flex;gap:1rem;}
    .org-stat{text-align:center;}
    .org-stat .n{font-family:'Barlow Condensed',sans-serif;font-size:1.2rem;font-weight:900;color:var(--white);}
    .org-stat .l{font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;color:rgba(244,241,236,.35);}
    .org-actions{display:flex;gap:.5rem;margin-top:.9rem;padding-top:.9rem;border-top:1px solid var(--border);}

    /* TABLE */
    .table-wrap{background:rgba(15,28,46,.7);border:1px solid var(--border);border-radius:6px;overflow:hidden;}
    table{width:100%;border-collapse:collapse;}
    thead th{background:rgba(245,166,35,.08);padding:.7rem 1rem;text-align:left;font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--gold);border-bottom:1px solid var(--border);white-space:nowrap;}
    tbody td{padding:.7rem 1rem;border-bottom:1px solid rgba(255,255,255,.04);font-size:.85rem;color:var(--off);vertical-align:middle;}
    tbody tr:last-child td{border-bottom:none;}
    tbody tr:hover td{background:rgba(255,255,255,.02);}
    .style-pill{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;border-radius:100px;font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;}
    .pill-D{background:rgba(26,90,138,.2);color:#5B9BD5;border:1px solid rgba(26,90,138,.4);}
    .pill-I{background:rgba(245,166,35,.15);color:var(--gold);border:1px solid rgba(245,166,35,.3);}
    .pill-S{background:rgba(46,139,87,.15);color:#4ade80;border:1px solid rgba(46,139,87,.3);}
    .pill-C{background:rgba(232,93,26,.15);color:var(--orange);border:1px solid rgba(232,93,26,.3);}

    /* FILTER ROW */
    .filter-row{display:flex;gap:.75rem;margin-bottom:1.25rem;flex-wrap:wrap;align-items:center;}
    .filter-row select,.filter-row input{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:4px;padding:.55rem .9rem;font-family:'Barlow',sans-serif;font-size:.85rem;color:var(--white);outline:none;}
    .filter-row select option{background:var(--mid);}
    .filter-row input::placeholder{color:rgba(244,241,236,.3);}

    /* CHART SECTION */
    .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;}
    .chart-card{background:rgba(15,28,46,.7);border:1px solid var(--border);border-radius:6px;padding:1.5rem;}
    .chart-card h3{font-family:'Barlow Condensed',sans-serif;font-size:.9rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(244,241,236,.5);margin-bottom:1.25rem;}
    .chart-wrap{position:relative;height:220px;}

    /* CREATE ORG MODAL */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center;padding:1rem;}
    .modal-overlay.open{display:flex;}
    .modal{background:var(--mid);border:1px solid var(--border);border-radius:8px;padding:2rem;width:100%;max-width:460px;}
    .modal h2{font-family:'Barlow Condensed',sans-serif;font-size:1.3rem;font-weight:800;text-transform:uppercase;margin-bottom:1.25rem;}
    .modal-field{margin-bottom:1rem;}
    .modal-field label{display:block;font-family:'Barlow Condensed',sans-serif;font-size:.75rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--gold);margin-bottom:.4rem;}
    .modal-field input,.modal-field select{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:4px;padding:.7rem .9rem;font-family:'Barlow',sans-serif;font-size:.9rem;color:var(--white);outline:none;}
    .modal-field input:focus{border-color:rgba(245,166,35,.4);}
    .modal-actions{display:flex;gap:.75rem;justify-content:flex-end;margin-top:1.25rem;}
    .generated-code{font-family:'Barlow Condensed',sans-serif;font-size:2rem;font-weight:900;letter-spacing:.3em;color:var(--gold);text-align:center;padding:1rem;background:rgba(245,166,35,.08);border:1px solid rgba(245,166,35,.2);border-radius:4px;margin:.75rem 0;}

    /* EMPTY STATE */
    .empty-state{text-align:center;padding:3rem 2rem;color:rgba(244,241,236,.3);}
    .empty-state .icon{font-size:2.5rem;margin-bottom:.75rem;display:block;}
    .empty-state p{font-size:.9rem;}

    /* SPINNER */
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(244,241,236,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:.3rem;}
    @keyframes spin{to{transform:rotate(360deg);}}

    @media(max-width:900px){.stats-row{grid-template-columns:repeat(2,1fr);}.chart-grid{grid-template-columns:1fr;}}
    @media(max-width:600px){.stats-row{grid-template-columns:1fr 1fr;}.main{padding:1rem;}.topbar{padding:.75rem 1rem;}}
  </style>
</head>
<body>

<!-- â•â•â• LOGIN â•â•â• -->
<div id="login-screen">
  <div class="login-card">
    <h1>DISC <em>Paradigmâ„¢</em></h1>
    <p>Admin Dashboard â€” KSWhite Consulting, LLC</p>
    <div class="login-field">
      <label>Admin Password</label>
      <input type="password" id="admin-pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')adminLogin()"/>
    </div>
    <button class="btn btn-primary" onclick="adminLogin()">Access Dashboard</button>
    <div class="login-error" id="login-error">Incorrect password. Try again.</div>
  </div>
</div>

<!-- â•â•â• DASHBOARD â•â•â• -->
<div id="dashboard">
  <div class="topbar">
    <div class="topbar-brand">DISC <span>Paradigmâ„¢</span> <span style="font-size:.75rem;color:rgba(244,241,236,.3);margin-left:.5rem;font-family:'Barlow',sans-serif;font-weight:300;">Admin</span></div>
    <div class="topbar-right">
      <span class="topbar-user">KSWhite Consulting, LLC</span>
      <button class="btn btn-ghost btn-sm" onclick="adminLogout()">Sign Out</button>
    </div>
  </div>

  <div class="main">
    <!-- STATS -->
    <div class="stats-row">
      <div class="stat-card"><div class="stat-n" id="stat-total">â€”</div><div class="stat-l">Total Participants</div></div>
      <div class="stat-card"><div class="stat-n" id="stat-orgs">â€”</div><div class="stat-l">Organizations</div></div>
      <div class="stat-card"><div class="stat-n" id="stat-today">â€”</div><div class="stat-l">Completed Today</div></div>
      <div class="stat-card"><div class="stat-n" id="stat-dominant">â€”</div><div class="stat-l">Most Common Primary</div></div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('tab-results',this)">Results</button>
      <button class="tab" onclick="switchTab('tab-orgs',this)">Organizations</button>
      <button class="tab" onclick="switchTab('tab-analytics',this)">Analytics</button>
    </div>

    <!-- TAB: RESULTS -->
    <div class="tab-panel active" id="tab-results">
      <div class="section-header">
        <div class="section-title">Participant Results</div>
        <div class="section-actions">
          <button class="btn btn-ghost btn-sm" onclick="exportCSV()">â¬‡ Export CSV</button>
          <button class="btn btn-ghost btn-sm" onclick="loadDashboard()">â†» Refresh</button>
        </div>
      </div>
      <div class="filter-row">
        <input type="text" id="search-input" placeholder="Search name, email, orgâ€¦" oninput="filterResults()" style="flex:1;min-width:180px;"/>
        <select id="filter-org" onchange="filterResults()"><option value="">All Organizations</option></select>
        <select id="filter-style" onchange="filterResults()">
          <option value="">All Primary Styles</option>
          <option value="D">Command (D)</option>
          <option value="I">Cohesion (I)</option>
          <option value="S">Stability (S)</option>
          <option value="C">Precision (C)</option>
        </select>
        <select id="filter-track" onchange="filterResults()">
          <option value="">Both Tracks</option>
          <option value="military">Military</option>
          <option value="corporate">Corporate</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Name</th><th>Email</th><th>Organization</th><th>Role</th>
            <th>Track</th><th>Primary</th><th>Secondary</th>
            <th>D%</th><th>I%</th><th>S%</th><th>C%</th><th>Date</th>
          </tr></thead>
          <tbody id="results-tbody">
            <tr><td colspan="12" style="text-align:center;padding:2rem;color:rgba(244,241,236,.3);">
              <span class="spinner"></span>Loading resultsâ€¦
            </td></tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top:.75rem;font-size:.78rem;color:rgba(244,241,236,.3);" id="results-count"></div>
    </div>

    <!-- TAB: ORGANIZATIONS -->
    <div class="tab-panel" id="tab-orgs">
      <div class="section-header">
        <div class="section-title">Organizations & Access Codes</div>
        <div class="section-actions">
          <button class="btn btn-gold btn-sm" onclick="openCreateOrg()">+ Create Organization</button>
        </div>
      </div>
      <div class="org-grid" id="org-grid">
        <div class="empty-state"><span class="icon">ğŸ¢</span><p>No organizations yet. Create one to generate an access code.</p></div>
      </div>
    </div>

    <!-- TAB: ANALYTICS -->
    <div class="tab-panel" id="tab-analytics">
      <div class="section-header">
        <div class="section-title">Performance Analytics</div>
        <select id="analytics-org" onchange="renderAnalytics()" style="background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:4px;padding:.5rem .9rem;font-family:'Barlow',sans-serif;font-size:.85rem;color:var(--white);outline:none;">
          <option value="">All Organizations</option>
        </select>
      </div>
      <div class="chart-grid">
        <div class="chart-card">
          <h3>Style Distribution â€” Primary Styles</h3>
          <div class="chart-wrap"><canvas id="chart-distribution"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>Average Score by Style</h3>
          <div class="chart-wrap"><canvas id="chart-averages"></canvas></div>
        </div>
      </div>
      <div class="chart-grid">
        <div class="chart-card">
          <h3>Military vs Corporate Track Split</h3>
          <div class="chart-wrap"><canvas id="chart-track"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>Top Primary + Secondary Combinations</h3>
          <div class="chart-wrap"><canvas id="chart-blends"></canvas></div>
        </div>
      </div>
      <div style="margin-top:1.5rem;">
        <div class="section-title" style="margin-bottom:1rem;">Organization Summary Table</div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>Organization</th><th>Participants</th>
              <th>Avg Command</th><th>Avg Cohesion</th><th>Avg Stability</th><th>Avg Precision</th>
              <th>Top Style</th><th>Track</th>
            </tr></thead>
            <tbody id="org-summary-tbody">
              <tr><td colspan="8" style="text-align:center;padding:2rem;color:rgba(244,241,236,.3);">Load data to see org summary</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• CREATE ORG MODAL â•â•â• -->
<div class="modal-overlay" id="create-org-modal">
  <div class="modal">
    <h2>Create Organization</h2>
    <div id="modal-form">
      <div class="modal-field">
        <label>Organization Name</label>
        <input type="text" id="new-org-name" placeholder="e.g., Harris County HR, 75th Innovation Command"/>
      </div>
      <div class="modal-field">
        <label>Type</label>
        <select id="new-org-type">
          <option value="military">Military / Government</option>
          <option value="corporate">Corporate</option>
          <option value="nonprofit">Nonprofit</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="modal-field">
        <label>Max Participants (0 = unlimited)</label>
        <input type="number" id="new-org-max" value="0" min="0"/>
      </div>
      <div class="modal-field">
        <label>Notes (optional)</label>
        <input type="text" id="new-org-notes" placeholder="e.g., Training cohort Jan 2026"/>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-gold" onclick="createOrg()">Generate Code â†’</button>
      </div>
    </div>
    <div id="modal-success" style="display:none;text-align:center;">
      <p style="font-size:.9rem;color:var(--off);margin-bottom:.5rem;">Access code generated for</p>
      <p style="font-family:'Barlow Condensed',sans-serif;font-size:1.1rem;font-weight:700;" id="modal-org-name-display"></p>
      <div class="generated-code" id="modal-code-display"></div>
      <p style="font-size:.82rem;color:rgba(244,241,236,.4);margin-bottom:1.5rem;">Share this code with participants. They will enter it to access the assessment.</p>
      <div style="display:flex;gap:.75rem;justify-content:center;">
        <button class="btn btn-ghost btn-sm" onclick="copyCode()">ğŸ“‹ Copy Code</button>
        <button class="btn btn-gold btn-sm" onclick="closeModal();loadDashboard();">Done</button>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” update with your actual Worker URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WORKER_URL = 'https://disc-paradigm-worker.YOUR-SUBDOMAIN.workers.dev';
const ADMIN_PASSWORD_HASH = 'CHANGE_THIS_TO_YOUR_PASSWORD'; // Set in Worker, not here

const STYLE_NAMES = { D:'Command', I:'Cohesion', S:'Stability', C:'Precision' };
let allResults = [];
let allOrgs = [];
let adminToken = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function adminLogin() {
  const pw = document.getElementById('admin-pw').value;
  if (!pw) return;
  try {
    const res = await fetch(`${WORKER_URL}/admin/login`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({password:pw})
    });
    const data = await res.json();
    if (data.token) {
      adminToken = data.token;
      sessionStorage.setItem('disc_admin_token', adminToken);
      showDashboard();
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  } catch(e) {
    // DEV fallback
    if (pw === 'disc2025admin') {
      adminToken = 'dev-token';
      sessionStorage.setItem('disc_admin_token','dev-token');
      showDashboard();
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  }
}

function adminLogout() {
  sessionStorage.removeItem('disc_admin_token');
  adminToken = '';
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('admin-pw').value = '';
}

function showDashboard() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  loadDashboard();
}

// Check existing session
window.addEventListener('load', () => {
  const t = sessionStorage.getItem('disc_admin_token');
  if (t) { adminToken = t; showDashboard(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  await Promise.all([loadResults(), loadOrgs()]);
  updateStats();
  renderAnalytics();
}

async function loadResults() {
  try {
    const res = await fetch(`${WORKER_URL}/admin/results`, {
      headers:{'Authorization':`Bearer ${adminToken}`}
    });
    allResults = await res.json();
  } catch(e) {
    allResults = getSampleData();
  }
  renderResultsTable(allResults);
  populateFilterOrgs();
}

async function loadOrgs() {
  try {
    const res = await fetch(`${WORKER_URL}/admin/orgs`, {
      headers:{'Authorization':`Bearer ${adminToken}`}
    });
    allOrgs = await res.json();
  } catch(e) {
    allOrgs = getSampleOrgs();
  }
  renderOrgGrid();
  populateAnalyticsOrgFilter();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  document.getElementById('stat-total').textContent = allResults.length;
  document.getElementById('stat-orgs').textContent = allOrgs.length;
  const today = new Date().toDateString();
  const todayCount = allResults.filter(r => new Date(r.timestamp).toDateString() === today).length;
  document.getElementById('stat-today').textContent = todayCount;
  if (allResults.length > 0) {
    const counts = {D:0,I:0,S:0,C:0};
    allResults.forEach(r => counts[r.primary]++);
    const dom = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
    document.getElementById('stat-dominant').textContent = STYLE_NAMES[dom];
  } else {
    document.getElementById('stat-dominant').textContent = 'â€”';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResultsTable(data) {
  const tbody = document.getElementById('results-tbody');
  document.getElementById('results-count').textContent = `Showing ${data.length} result${data.length!==1?'s':''}`;
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="12"><div class="empty-state"><span class="icon">ğŸ“Š</span><p>No results yet. Share access codes with participants to get started.</p></div></td></tr>';
    return;
  }
  tbody.innerHTML = data.map(r => `
    <tr>
      <td style="font-weight:500;color:var(--white);">${esc(r.name)}</td>
      <td><a href="mailto:${esc(r.email)}" style="color:var(--gold);text-decoration:none;">${esc(r.email)}</a></td>
      <td>${esc(r.orgName||r.org)}</td>
      <td>${esc(r.role)}</td>
      <td><span class="style-pill pill-${r.track==='military'?'D':'I'}" style="background:rgba(255,255,255,.06);color:rgba(244,241,236,.5);border:none;">
        ${r.track==='military'?'ğŸ–ï¸ Mil':'ğŸ¢ Corp'}
      </span></td>
      <td><span class="style-pill pill-${r.primary}">${STYLE_NAMES[r.primary]}</span></td>
      <td><span class="style-pill pill-${r.secondary}">${STYLE_NAMES[r.secondary]}</span></td>
      <td style="color:${getStyleColor('D')}">${r.scores?.D||0}%</td>
      <td style="color:${getStyleColor('I')}">${r.scores?.I||0}%</td>
      <td style="color:${getStyleColor('S')}">${r.scores?.S||0}%</td>
      <td style="color:${getStyleColor('C')}">${r.scores?.C||0}%</td>
      <td style="color:rgba(244,241,236,.4);">${formatDate(r.timestamp)}</td>
    </tr>
  `).join('');
}

function filterResults() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const org = document.getElementById('filter-org').value;
  const style = document.getElementById('filter-style').value;
  const track = document.getElementById('filter-track').value;
  const filtered = allResults.filter(r => {
    const matchQ = !q || [r.name,r.email,r.orgName,r.org,r.role].some(f=>(f||'').toLowerCase().includes(q));
    const matchOrg = !org || r.orgId===org || r.orgName===org;
    const matchStyle = !style || r.primary===style;
    const matchTrack = !track || r.track===track;
    return matchQ && matchOrg && matchStyle && matchTrack;
  });
  renderResultsTable(filtered);
}

function populateFilterOrgs() {
  const sel = document.getElementById('filter-org');
  const current = sel.value;
  sel.innerHTML = '<option value="">All Organizations</option>';
  const orgs = [...new Set(allResults.map(r=>r.orgName||r.org).filter(Boolean))];
  orgs.forEach(o => sel.innerHTML += `<option value="${esc(o)}">${esc(o)}</option>`);
  sel.value = current;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOrgGrid() {
  const grid = document.getElementById('org-grid');
  if (!allOrgs.length) {
    grid.innerHTML = '<div class="empty-state"><span class="icon">ğŸ¢</span><p>No organizations yet. Create one to generate an access code.</p></div>';
    return;
  }
  grid.innerHTML = allOrgs.map(o => {
    const orgResults = allResults.filter(r => r.orgId===o.id);
    return `
      <div class="org-card">
        <div class="org-name">${esc(o.name)}</div>
        <div style="font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;color:rgba(244,241,236,.35);margin-bottom:.3rem;">${o.type||'Organization'}</div>
        <div class="org-code">${o.code}</div>
        <div class="org-meta">
          Created ${formatDate(o.createdAt)}
          ${o.maxParticipants>0?` Â· Max ${o.maxParticipants}`:''}
          ${o.notes?`<br/><em>${esc(o.notes)}</em>`:''}
        </div>
        <div class="org-stats">
          <div class="org-stat"><div class="n">${orgResults.length}</div><div class="l">Completed</div></div>
          <div class="org-stat"><div class="n">${getTopStyle(orgResults)||'â€”'}</div><div class="l">Top Style</div></div>
        </div>
        <div class="org-actions">
          <button class="btn btn-ghost btn-sm" onclick="copyText('${o.code}')">ğŸ“‹ Copy Code</button>
          <button class="btn btn-ghost btn-sm" onclick="viewOrgResults('${esc(o.id)}')">View Results</button>
          <button class="btn btn-danger btn-sm" onclick="deactivateOrg('${esc(o.id)}')">Deactivate</button>
        </div>
      </div>
    `;
  }).join('');
}

function getTopStyle(results) {
  if (!results.length) return null;
  const counts = {D:0,I:0,S:0,C:0};
  results.forEach(r=>counts[r.primary]++);
  const top = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
  return STYLE_NAMES[top];
}

function viewOrgResults(orgId) {
  document.getElementById('filter-org').value = orgId;
  switchTab('tab-results', document.querySelectorAll('.tab')[0]);
  filterResults();
}

async function createOrg() {
  const name = document.getElementById('new-org-name').value.trim();
  const type = document.getElementById('new-org-type').value;
  const max = parseInt(document.getElementById('new-org-max').value)||0;
  const notes = document.getElementById('new-org-notes').value.trim();
  if (!name) return alert('Please enter an organization name.');
  try {
    const res = await fetch(`${WORKER_URL}/admin/create-org`, {
      method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
      body: JSON.stringify({name, type, maxParticipants:max, notes})
    });
    const data = await res.json();
    showCodeSuccess(name, data.code);
    allOrgs.push(data);
    renderOrgGrid();
  } catch(e) {
    // DEV fallback
    const code = generateCode();
    showCodeSuccess(name, code);
  }
}

function generateCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:8}, ()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

function showCodeSuccess(name, code) {
  document.getElementById('modal-form').style.display = 'none';
  document.getElementById('modal-success').style.display = 'block';
  document.getElementById('modal-org-name-display').textContent = name;
  document.getElementById('modal-code-display').textContent = code;
  window._lastCode = code;
}

function copyCode() { copyText(window._lastCode); }
function copyText(t) { navigator.clipboard.writeText(t).then(()=>alert(`Copied: ${t}`)); }

async function deactivateOrg(id) {
  if (!confirm('Deactivate this organization? The access code will stop working.')) return;
  try {
    await fetch(`${WORKER_URL}/admin/deactivate-org`, {
      method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
      body: JSON.stringify({orgId:id})
    });
    allOrgs = allOrgs.filter(o=>o.id!==id);
    renderOrgGrid();
  } catch(e) { allOrgs = allOrgs.filter(o=>o.id!==id); renderOrgGrid(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYTICS CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const chartInstances = {};
function destroyChart(id) { if(chartInstances[id]){chartInstances[id].destroy();delete chartInstances[id];} }

function renderAnalytics() {
  const orgId = document.getElementById('analytics-org').value;
  const data = orgId ? allResults.filter(r=>r.orgId===orgId||r.orgName===orgId) : allResults;

  // Distribution
  destroyChart('dist');
  const counts = {D:0,I:0,S:0,C:0};
  data.forEach(r=>counts[r.primary]++);
  chartInstances['dist'] = new Chart(document.getElementById('chart-distribution').getContext('2d'),{
    type:'doughnut',
    data:{
      labels:['Command (D)','Cohesion (I)','Stability (S)','Precision (C)'],
      datasets:[{data:[counts.D,counts.I,counts.S,counts.C],backgroundColor:['rgba(26,90,138,.8)','rgba(245,166,35,.8)','rgba(46,139,87,.8)','rgba(232,93,26,.8)'],borderWidth:0}]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'rgba(244,241,236,.6)',font:{family:"'Barlow Condensed'",size:11}}}}}
  });

  // Averages
  destroyChart('avg');
  const avgs = {D:0,I:0,S:0,C:0};
  if(data.length){['D','I','S','C'].forEach(s=>{avgs[s]=Math.round(data.reduce((a,r)=>a+(r.scores?.[s]||0),0)/data.length);});}
  chartInstances['avg'] = new Chart(document.getElementById('chart-averages').getContext('2d'),{
    type:'bar',
    data:{
      labels:['Command','Cohesion','Stability','Precision'],
      datasets:[{data:[avgs.D,avgs.I,avgs.S,avgs.C],backgroundColor:['rgba(26,90,138,.8)','rgba(245,166,35,.8)','rgba(46,139,87,.8)','rgba(232,93,26,.8)'],borderRadius:3}]
    },
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:0,max:100,ticks:{color:'rgba(244,241,236,.4)'},grid:{color:'rgba(255,255,255,.05)'}},x:{ticks:{color:'rgba(244,241,236,.5)',font:{family:"'Barlow Condensed'",weight:'700'}},grid:{display:false}}},plugins:{legend:{display:false}}}
  });

  // Track split
  destroyChart('track');
  const mil = data.filter(r=>r.track==='military').length;
  const corp = data.filter(r=>r.track==='corporate').length;
  chartInstances['track'] = new Chart(document.getElementById('chart-track').getContext('2d'),{
    type:'pie',
    data:{labels:['Military','Corporate'],datasets:[{data:[mil,corp],backgroundColor:['rgba(26,90,138,.8)','rgba(245,166,35,.8)'],borderWidth:0}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'rgba(244,241,236,.6)',font:{family:"'Barlow Condensed'",size:11}}}}}
  });

  // Blends
  destroyChart('blends');
  const blendCounts = {};
  data.forEach(r=>{ const k=`${STYLE_NAMES[r.primary]}+${STYLE_NAMES[r.secondary]}`; blendCounts[k]=(blendCounts[k]||0)+1; });
  const topBlends = Object.entries(blendCounts).sort((a,b)=>b[1]-a[1]).slice(0,6);
  chartInstances['blends'] = new Chart(document.getElementById('chart-blends').getContext('2d'),{
    type:'bar',
    data:{labels:topBlends.map(b=>b[0]),datasets:[{data:topBlends.map(b=>b[1]),backgroundColor:'rgba(245,166,35,.6)',borderRadius:3}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{color:'rgba(244,241,236,.4)',stepSize:1},grid:{color:'rgba(255,255,255,.05)'}},y:{ticks:{color:'rgba(244,241,236,.6)',font:{family:"'Barlow Condensed'",size:10}},grid:{display:false}}},plugins:{legend:{display:false}}}
  });

  // Org summary table
  renderOrgSummary(data);
}

function renderOrgSummary(data) {
  const tbody = document.getElementById('org-summary-tbody');
  const byOrg = {};
  data.forEach(r => {
    const k = r.orgName||r.org||'Unknown';
    if(!byOrg[k]) byOrg[k]={name:k,results:[],tracks:{military:0,corporate:0}};
    byOrg[k].results.push(r);
    byOrg[k].tracks[r.track]=(byOrg[k].tracks[r.track]||0)+1;
  });
  if(!Object.keys(byOrg).length){
    tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:2rem;color:rgba(244,241,236,.3);">No data available</td></tr>';
    return;
  }
  tbody.innerHTML = Object.values(byOrg).map(o => {
    const n=o.results.length;
    const avg=s=>n?Math.round(o.results.reduce((a,r)=>a+(r.scores?.[s]||0),0)/n):0;
    const top=getTopStyle(o.results)||'â€”';
    const domTrack=o.tracks.military>=o.tracks.corporate?'ğŸ–ï¸ Military':'ğŸ¢ Corporate';
    return `<tr>
      <td style="font-weight:500;color:var(--white);">${esc(o.name)}</td>
      <td>${n}</td>
      <td style="color:${getStyleColor('D')}">${avg('D')}%</td>
      <td style="color:${getStyleColor('I')}">${avg('I')}%</td>
      <td style="color:${getStyleColor('S')}">${avg('S')}%</td>
      <td style="color:${getStyleColor('C')}">${avg('C')}%</td>
      <td><span class="style-pill pill-${Object.keys(STYLE_NAMES).find(k=>STYLE_NAMES[k]===top)||'D'}">${top}</span></td>
      <td style="font-size:.8rem;color:rgba(244,241,236,.5);">${domTrack}</td>
    </tr>`;
  }).join('');
}

function populateAnalyticsOrgFilter() {
  const sel = document.getElementById('analytics-org');
  sel.innerHTML = '<option value="">All Organizations</option>';
  allOrgs.forEach(o => sel.innerHTML += `<option value="${esc(o.id)}">${esc(o.name)}</option>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const headers = ['Name','Email','Organization','Role','Track','Primary','Secondary','D%','I%','S%','C%','Date'];
  const rows = allResults.map(r=>[
    r.name,r.email,r.orgName||r.org,r.role,r.track,
    STYLE_NAMES[r.primary],STYLE_NAMES[r.secondary],
    r.scores?.D||0,r.scores?.I||0,r.scores?.S||0,r.scores?.C||0,
    formatDate(r.timestamp)
  ].map(v=>`"${String(v).replace(/"/g,'""')}"`));
  const csv = [headers.join(','),...rows.map(r=>r.join(','))].join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = `disc-paradigm-results-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id, btn) {
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
}
function openCreateOrg() {
  document.getElementById('modal-form').style.display='block';
  document.getElementById('modal-success').style.display='none';
  document.getElementById('new-org-name').value='';
  document.getElementById('new-org-notes').value='';
  document.getElementById('create-org-modal').classList.add('open');
}
function closeModal() { document.getElementById('create-org-modal').classList.remove('open'); }
document.getElementById('create-org-modal').addEventListener('click', e=>{ if(e.target===e.currentTarget)closeModal(); });

function getStyleColor(s){return{D:'#5B9BD5',I:'#F5A623',S:'#4ade80',C:'#E85D1A'}[s]||'#fff';}
function formatDate(ts){if(!ts)return'â€”';const d=new Date(ts);return isNaN(d)?'â€”':d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// Sample data for development/demo
function getSampleData(){
  return [
    {name:'Sgt. Marcus Williams',email:'m.williams@email.com',orgName:'75th Innovation Command',org:'75th Innovation Command',orgId:'org1',role:'Staff Sergeant',track:'military',primary:'D',secondary:'I',scores:{D:82,I:68,S:55,C:48},timestamp:'2026-02-10T14:22:00Z'},
    {name:'Jennifer Chen',email:'j.chen@harcotx.gov',orgName:'Harris County HR',org:'Harris County HR',orgId:'org2',role:'Senior HR Manager',track:'corporate',primary:'C',secondary:'S',scores:{D:45,I:52,S:75,C:88},timestamp:'2026-02-12T10:05:00Z'},
    {name:'Lt. David Okafor',email:'d.okafor@army.mil',orgName:'75th Innovation Command',org:'75th Innovation Command',orgId:'org1',role:'Lieutenant',track:'military',primary:'I',secondary:'D',scores:{D:70,I:85,S:62,C:43},timestamp:'2026-02-13T09:30:00Z'},
    {name:'Rachel Torres',email:'r.torres@harcotx.gov',orgName:'Harris County HR',org:'Harris County HR',orgId:'org2',role:'Talent Acquisition Specialist',track:'corporate',primary:'S',secondary:'I',scores:{D:40,I:72,S:80,C:65},timestamp:'2026-02-14T16:45:00Z'},
    {name:'Capt. Aisha Johnson',email:'a.johnson@army.mil',orgName:'75th Innovation Command',org:'75th Innovation Command',orgId:'org1',role:'Captain',track:'military',primary:'D',secondary:'C',scores:{D:90,I:55,S:48,C:72},timestamp:'2026-02-15T08:15:00Z'},
  ];
}
function getSampleOrgs(){
  return [
    {id:'org1',name:'75th Innovation Command',code:'INNO2026',type:'military',maxParticipants:0,notes:'Annual leadership cohort',createdAt:'2026-01-15T00:00:00Z'},
    {id:'org2',name:'Harris County HR',code:'HARCO26',type:'corporate',maxParticipants:50,notes:'Phase 3 training group',createdAt:'2026-01-20T00:00:00Z'},
  ];
}
</script>
</body>
</html>
